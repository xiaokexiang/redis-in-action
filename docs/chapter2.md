### Redis持久化

> Redis提供了两种`持久化`方法用于将数据存储到硬盘：`快照和只追加文件`。
>
> 这两种方法和可以同时使用，也可以单独使用。

#### 快照

Redis可以通过创建`快照(snapshotting)`来获得存储在内存里面的数据在`某个时间点`上的副本。若在新的快照文件创建完毕之前，系统、redis或硬件中任意一个崩溃，那么Redis将会`丢失`最近一次创建快照之后写入的所有数据。

> 快照的持久化方式适合`即使丢了一部分数据也不会造成问题的应用程序`。

##### 快照的创建方式

- `BGSAVE`命令创建快照，Redis会调用`fork`来创建一个子进程，然后子进程负责将`快照写入磁盘`，而父进程负责继续处理命令请求。

> 当一个线程创建子进程时，系统底层会创建该`进程的一个副本。在unix系统中，刚开始时，父子进程`共享相同的内存`，直到父或子进程对内存进行写入后，对被写入内存的共享才会结束

- `SAVE`命令创建快照，Redis服务器接收到此请求后，在快照创建完成之前`不会响应`任何其他命令。该命令一般只在没有足够内存执行`BGSAVE`命令时才会使用。
- `SAVE 60 1000`命令，从Redis最近一次创建快照之后算起，当`60s内有1000次写入`这个条件被满足，Redis会自动触发`BGSAVE`命令。任意一个`SAVE ？ ？`命令满足时就会触发一次`BGSAVE`命令。

> 假如我们能接受一个小时数据的丢失，可以使用`SAVE 3600 1`。即`3600s内`有一次写入就创建快照。

- Redis接收到`SHUTDOWN`命令或`TERM`命令时，就会执行`SAVE`命令，阻塞所有客户端，不执行任何客户端发送的命令，并在`SAVE`命令执行完毕后关闭服务器。
- 当一个Redis服务器连接另一个Redis服务器时，通过`SYNC`命令开始一次复制操作的时候，若主服务器没有正在执行或刚执行过`BGSAVE`命令，那么主服务器就会执行`BGSAVE`命令。

##### SAVE or BGSAVE

我们知道`SAVE`生成快照期间会阻塞所有的客户端命令，而`BGSAVE`通过创建子进程实现的`快照`生成会带来短暂的停顿，这种情况在Redis进程占用的内存越大的情况下越明显。`一般来说Redis进程每多占用1GB内存，创建该进程的子进程的耗时就增加10-20ms`。

为了防止创建子进程而出现的停顿，我们可以考虑关闭`自动保存`，通过手动发送`BGSAVE`命令控制停顿出现的时间。虽然`SAVE`会一直阻塞Redis直到快照生成完毕，但因为`SAVE`不需要创建子进程，不会导致Redis停顿且没有子进程竞争，所以`SAVE`创建快照的速度会比`BGSAVE`创建快照的时候`更短`。

---

#### 只追加文件

